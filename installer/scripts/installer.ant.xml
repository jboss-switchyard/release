<!--
  ~ JBoss, Home of Professional Open Source
  ~ Copyright 2011 Red Hat Inc. and/or its affiliates and other contributors
  ~ as indicated by the @author tags. All rights reserved.
  ~ See the copyright.txt in the distribution for a
  ~ full listing of individual contributors.
  ~
  ~ This copyrighted material is made available to anyone wishing to use,
  ~ modify, copy, or redistribute it subject to the terms and conditions
  ~ of the GNU Lesser General Public License, v. 2.1.
  ~ This program is distributed in the hope that it will be useful, but WITHOUT A
  ~ WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
  ~ PARTICULAR PURPOSE.  See the GNU Lesser General Public License for more details.
  ~ You should have received a copy of the GNU Lesser General Public License,
  ~ v.2.1 along with this distribution; if not, write to the Free Software
  ~ Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston,
  ~ MA  02110-1301, USA.
  -->

<project name="SwitchYard AS7 Installer" default="install" basedir=".">

    <target name="get-jboss-path" unless="AS7_PATH">
        <input message="Please enter the path to the root folder of your JBoss AS7 installation: " addproperty="AS7_PATH_ENTERED" />
        <pathconvert targetos="unix" property="AS7_PATH">
            <path>
                <pathelement location="${AS7_PATH_ENTERED}"/>
            </path>
        </pathconvert>
    </target>

    <target name="install" description="Install SwitchYard into JBoss (optionally specified by AS7_PATH)" depends="get-jboss-path">
        <property name="QUICKSTART_PATH" value="${basedir}"/>
        <condition property="isAS7">
            <available file="${AS7_PATH}/jboss-modules.jar" />
        </condition>
        <antcall target="notAS7" />

        <condition property="quickstartResourcesAlreadyInstalled">
            <available file="quickstarts" filepath="${QUICKSTART_PATH}" />
        </condition>
        <condition property="switchyardResourcesAlreadyInstalled">
            <available file="switchyard" filepath="${AS7_PATH}/modules/org" />
        </condition>
        <antcall target="unzipSwitchyardResources" />
        <antcall target="unzipQuickstartResources" />
    </target>

    <target name="unzipSwitchyardResources" unless="switchyardResourcesAlreadyInstalled">
        <!-- Install into the AS7 install.... -->
        <unzip src="res/SwitchYard-AS7-Bundle.zip" dest="${AS7_PATH}" overwrite="true">
            <patternset>
                <include name="standalone/**" />
                <include name="modules/**" />
            </patternset>
        </unzip>
        <xslt style="res/standalone.xsl"
              basedir="${AS7_PATH}/standalone/configuration"
              destdir="${AS7_PATH}/standalone/configuration"
              includes="standalone.xml,standalone-preview.xml"/>
        <move overwrite="true" todir="${AS7_PATH}/standalone/configuration">
          <filelist dir="${AS7_PATH}/standalone/configuration">
            <file name="standalone.html"/>
            <file name="standalone-preview.html"/>
          </filelist>
          <mapper type="regexp" from="^(.*)\.html$$" to="\1.xml"/>
        </move>
    </target>

    <target name="unzipQuickstartResources" unless="quickstartResourcesAlreadyInstalled">
        <!-- Install SwitchYard stuff into this directory.... -->
        <unzip src="res/SwitchYard-AS7-Bundle.zip" dest="${QUICKSTART_PATH}" overwrite="true">
            <patternset>
                <include name="quickstarts/**" />
            </patternset>
        </unzip>
    </target>

    <target name="notAS7" unless="isAS7">
        <fail message="Sorry, but the specified path '${AS7_PATH}' is not a path to a valid JBoss AS7 installation." />
    </target>

    <target name="install-forge">
        <condition property="forge.plugindir.exists">
            <available file="config" filepath="${user.home}/.forge" />
        </condition>

	<fail unless="forge.plugindir.exists" message="Cannot find ${user.home}/forge/config.   Please run forge 1.0.0.beta3 before installing."/>

	<echo>Creating switchyard directory...</echo>
	<mkdir dir="${user.home}/.forge/plugins/org/switchyard"/>
	<echo>Unzipping switchyard forge plugin module...</echo>
	<unzip dest="${user.home}/.forge/plugins/org/switchyard"
		src="switchyard-forge-plugin.zip"/>
	<echo>Unzipped SwitchYard forge plugin.</echo>
    </target>

</project>
